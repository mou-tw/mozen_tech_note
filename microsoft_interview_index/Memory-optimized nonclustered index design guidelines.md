這種索引是專門給放在記憶體裡的資料表用的，跟一般的磁碟式資料表不一樣。它採用一種叫做 **Bw-tree** 的資料結構，這種結構特別在於：

- **不鎖住資料**：查資料和改資料時，不需要加鎖或加閂鎖（也就是不會造成資料衝突或卡住）。
- **查資料速度快**：特別適合用在「範圍查詢」或「不等於」這類複雜查詢。
- **自動維護**：它會自己合併、分裂或重整索引資料，讓效能維持穩定。

這種索引不是用傳統 B-tree 的方式來更新資料，而是用「加筆記」的方式記下來（稱為 delta records），然後有需要時再把這些改動整合起來。

- **要插入新資料時**：如果空間不夠，會把資料頁切一半（Split）。
    
- **要刪資料時**：會先標記「這筆資料要刪」，然後如果這一頁剩太少資料，就把它跟隔壁合併（Merge）。
    
- **改資料時**：會加一筆「更新紀錄」，但不會真的動到舊資料。



跟 Hash Index 的比較

|特性|Hash Index|Nonclustered Index|
|---|---|---|
|精確查詢效率（等於）|✅ 最快|✅ 快|
|範圍查詢效率（大於、小於）|❌ 很差|✅ 很好|
|欄位重複多|❌ 掛得快|⚠ 可能效能變差|
|複合條件查詢支援|❌ 不靈活|✅ 靈活很多|
|可以查排序結果|❌ 不行|✅ 可以幫忙加速 `ORDER BY`|



- 用於 **Memory-Optimized Tables（記憶體內最佳化資料表）** 的一種索引。
- 與 Hash Index 相比，**支援範圍查詢（Range Scan）與不等式查詢**。
- 架構基於 **Bw-tree（B-link Write Optimized Tree）**，是 **無鎖（lock-free）、無閂鎖（latch-free）** 的 B-tree 變形。

|場景|是否適用 Nonclustered Index|
|---|---|
|範圍查詢（BETWEEN, >, <）|✅ 非常適合|
|複合條件查詢（OR, IN）|✅ 合理使用|
|頻繁寫入但欄位重複值多|⚠ 請慎用，可考慮增加索引鍵的 selectivity|
|快速單一主鍵查詢|❌ Hash index 效能更好|
|欲搭配 ORDER BY 使用索引|✅ 適合，有排序能力|

|特性|說明|
|---|---|
|**頁面導向邏輯**|每一層索引頁指向下一層（類似 B-tree）|
|**Page Map Table**|使用邏輯 Page ID，透過 Page Map Table 對應實體記憶體位址|
|**無鎖設計**|所有更新透過 **Delta Page** 處理，避免修改原始頁面|
|**版本鏈結**|同一索引鍵可有多個版本（支援 snapshot isolation）|


### Page Split（頁面分裂）

- 當頁面超過 8KB（儲存滿），會執行 **Split**。
    
- 兩階段處理：
    
    1. 分配兩個新頁面 P1 和 P2，並更新 Page Map 對應。
        
    2. 建立新的非葉節點指向 P2，更新 page mapping 表。
        
- 只有透過 P1 可訪問 P2（P2 是 right sibling）。


### Page Merge（頁面合併）

- 當刪除使頁面剩餘空間 < 10%，會觸發 Merge。
    
- 分三步：
    
    1. 新增 delta + merge-delta page，原頁轉指至 merge-delta。
        
    2. 建立新非葉節點頁，移除指向刪除鍵的連結。
        
    3. 合併相鄰頁面（如 P1, P2）並移除 delta，更新 Page Map。